# Get backbone tree
# insert
from ete3 import Tree       # To use for distance matrix
import os
import re
import logging


def read_backbone(backbone_file):
    with open(backbone_file, "r") as output:
        backbone = output.read()
    return backbone

def alter_backbone(backbone_file, subtree_file):
    """Get newick from RAXML output.
    Get leave info from the newick.
    Create a matrix based on the amount of leaves
    Get all names from the leaves and append to list.
    Use the get distance from ete3, to get the distance between two nodes.
    Use that distance to add to the dataframe.
    :return: dataframe containing distances.
    """

    tree = Tree(backbone_file,format=1)  # Format indicates newick structure in file
    leaves = list(tree.get_leaves())  # Get all leaves
    for i in range(len(leaves)):
        if (i % 2) == 0:
            leave_to_replace, tree2 = evaluate(leaves[i], subtree_file)
            if leave_to_replace:
                leaves[i].add_child(tree2)
                leaves[i].delete()
        else:
            leaves[i].delete()
    return tree

def evaluate(leave,subtree):
    #rep = "((((ott520664_5157:0.000001,((ott520664_3561:0.000001,(((ott520664_3118:0.000001,((((((((ott520664_7287:0.000001,(ott520664_2256:0.000001,(((ott520664_5088:0.000001,(ott520664_1955:0.000001,ott520664_1961:0.000001)n3254:0.000001):0.000001,(((ott520664_6325:0.000001,(ott520664_2665:0.000001,ott520664_6429:0.000001):0.000001):0.000001,ott520664_5112:0.000001):0.000001,((((ott520664_7443:0.000001,((ott520664_6659:0.000001,ott520664_2255:0.000001):0.000001,ott520664_2139:0.000001):0.000001):0.000001,ott520664_5945:0.000001):0.000001,ott520664_4748:0.000001):0.000001,(ott520664_5392:0.000001,ott520664_5598:0.000001)n3253:0.000001):0.000001):0.000001):0.000001,ott520664_5149:0.000001):0.000001):0.000001):0.000001,ott520664_2251:0.000001):0.000001,ott520664_5205:0.000001):0.000001,(ott520664_4078:0.000001,ott520664_4885:0.000001):0.000001):0.000001,ott520664_4574:0.000001):0.000001,((ott520664_4538:0.000001,ott520664_5013:0.000001):0.000001,ott520664_1969:0.000001):0.000001):0.000001,ott520664_5854:0.000001):0.000001,(ott520664_5313:0.000001,((ott520664_1828:0.000001,(((ott520664_2585:0.000001,((((((ott520664_6018:0.000001,ott520664_5294:0.000001):0.000001,ott520664_5759:0.000001):0.000001,ott520664_6212:0.000001):0.000001,((((((((((ott520664_5260:0.000001,ott520664_4703:0.000001):0.000001,ott520664_5435:0.000001):0.000001,ott520664_7307:0.000001):0.000001,(ott520664_3137:0.000001,((ott520664_6170:0.000001,ott520664_4695:0.000001):0.000001,(((((ott520664_4678:0.000001,ott520664_6845:0.000001):0.000001,ott520664_4094:0.000001):0.000001,ott520664_4587:0.000001):0.000001,ott520664_6437:0.000001):0.000001,ott520664_5200:0.000001):0.000001):0.000001):0.000001)n3240:0.000001,ott520664_6692:0.000001):0.000001,ott520664_4662:0.000001):0.000001,(ott520664_5288:0.000001,ott520664_4906:0.000001):0.000001):0.000001,ott520664_5761:0.000001)n3262:0.000001,ott520664_6401:0.000001)n3246:0.000001,ott520664_6619:0.000001):0.000001):0.000001,(((((((ott520664_5214:0.000001,ott520664_5613:0.000001):0.000001,ott520664_5574:0.000001):0.000001,ott520664_5329:0.000001):0.000001,(ott520664_5209:0.000001,ott520664_6517:0.000001):0.000001):0.000001,ott520664_5336:0.000001):0.000001,(ott520664_2235:0.000001,ott520664_4584:0.000001)n3283:0.000001):0.000001,(((((ott520664_6383:0.000001,(ott520664_3144:0.000001,(ott520664_3020:0.000001,(ott520664_6369:0.000001,(ott520664_3524:0.000001,ott520664_4865:0.000001):0.000001):0.000001):0.000001):0.000001):0.000001,(ott520664_1943:0.000001,((ott520664_3107:0.000001,ott520664_2465:0.000001):0.000001,ott520664_6027:0.000001):0.000001):0.000001):0.000001,ott520664_2362:0.000001):0.000001,ott520664_5800:0.000001):0.000001,ott520664_6664:0.000001):0.000001):0.000001):0.000001,(ott520664_3872:0.000001,ott520664_2711:0.000001):0.000001):0.000001):0.000001,ott520664_5742:0.000001):0.000001,ott520664_6900:0.000001):0.000001):0.000001,ott520664_3207:0.000001):0.000001):0.000001):0.000001):0.003668,(((((((ott502531_97554:0.000501,ott502531_97553:0.000001):0.006672,ott502531_97555:4.490739):0.000001,((ott281139_96836:0.006518,ott281139_96835:4.025842):0.000001,(ott4730035_182406:0.000001,ott4730035_182405:0.000001):4.402588):0.000001):0.000001,((((ott737357_177905:0.000001,ott737357_159396:0.000001):4.468020,ott737357_103560:0.011499):0.000001,((ott5147048_169387:100.000000,ott5147048_184787:4.459830):0.000001,ott5147048_169386:0.005750):0.000001):0.000001,((((ott992970_136775:4.430456,ott992970_136820:0.003044):0.000001,ott737362_94853:0.003513):0.001609,((ott4730036_139020:0.000001,ott282389_98540:0.000001):0.003965,(ott33097_178849:0.004124,ott33097_178850:4.609768):0.000001):0.000001):0.000669,(((ott737364_94894:4.209558,ott737364_94895:0.000492):0.000001,ott737364_94893:0.001652):0.001653,((ott1011202_95029:0.002283,ott1011202_178970:0.003903):4.627199,ott1011202_178969:0.002105):0.000001):0.000001):0.000895):0.003346):0.000001,(ott4730042_182638:4.531436,(((ott726773_97548:0.000001,(ott726773_97550:0.000001,ott726773_97552:0.000001):0.000001):0.000001,ott726773_97549:0.000001):0.000001,(ott726773_97551:0.003485,ott726773_97547:0.001279):0.000001):0.003812):0.000001):0.006626,(((ott6098850_184506:0.000001,ott6098850_1575:0.000001):0.002113,((ott520664_5192:0.000001,(ott520664_4733:0.000001,(((ott520664_5924:0.000001,ott520664_3355:0.000001):0.000001,(ott520664_7347:0.000001,ott520664_2593:0.000001):0.000001):0.000001,ott520664_7214:0.000001):0.000001):0.000001)n3255:0.003590,(((((ott520664_6862:0.000001,(ott520664_6082:0.000001,(((ott520664_4150:0.000001,ott520664_6758:0.000001):0.000001,(ott520664_2269:0.000001,ott520664_3838:0.000001):0.000001):0.000001,ott520664_2571:0.000001):0.000001):0.000001):0.000001,ott520664_4146:0.000001):0.001014,(ott520664_2677:0.000001,(((((((ott520664_6423:0.000001,ott520664_5397:0.000001):0.000001,ott520664_6189:0.000001):0.000001,ott520664_5547:0.000001):0.000001,(ott520664_2679:0.000001,ott520664_3042:0.000001):0.000001):0.000001,ott520664_5456:0.000001):0.000001,ott520664_5830:0.000001)n3247:0.000001,ott520664_6616:0.000001):0.000001):0.000947):0.003806,ott520664_5350:0.001067):0.002390,ott6098850_184505:0.002058):0.000001):4.745826):0.000024,(ott935894_102730:0.021718,(ott935894_102732:0.000001,ott935894_102731:0.000001):0.012481):0.010333):0.000001)n3272:0.000001,(ott5750361_151868:0.001202,((((((ott213624_4097:0.000001,(ott213624_2412:0.000001,ott213624_6360:0.000001):0.000001):0.000001,ott502535_102552:0.002087)n3250:4.505116,ott502535_102551:0.012732):0.000001,(((((((ott520664_4694:0.000001,(((ott520664_4537:0.000001,ott520664_2140:0.000001):0.000001,(ott520664_2464:0.000001,ott520664_5012:0.000001):0.000001):0.000001,((((ott520664_6026:0.000001,((ott520664_5523:0.000001,((ott520664_4456:0.000001,ott520664_5801:0.000001):0.000001,ott520664_2250:0.000001)n3248:0.000001):0.000001,(ott520664_5760:0.000001,((ott520664_2712:0.000001,(ott520664_5293:0.000001,ott520664_7306:0.000001):0.000001):0.000001,((ott520664_5741:0.000001,(ott520664_3108:0.000001,(ott520664_6017:0.000001,((((ott520664_4677:0.000001,(ott520664_6620:0.000001,ott520664_5330:0.000001):0.000001):0.000001,((ott520664_3138:0.000001,(ott520664_5150:0.000001,ott520664_6660:0.000001):0.000001):0.000001,ott520664_3145:0.000001):0.000001):0.000001,((ott520664_4747:0.000001,ott520664_1956:0.000001)n3264:0.000001,(ott520664_4702:0.000001,(((((ott520664_5208:0.000001,(((ott729276_166284:100.000000,(ott520664_2586:0.000001,ott520664_3117:0.000001):0.000950):0.000073,ott520664_4093:0.000001):0.000001,ott520664_5201:0.000001):0.000001):0.000001,ott520664_5436:0.000001):0.000001,ott520664_4079:0.000001):0.000001,ott520664_3871:0.000001):0.000001,ott520664_5391:0.000001):0.000001):0.000001):0.000001):0.000001,ott520664_6368:0.000001):0.000001)n3247:0.000001):0.000001):0.000001,((ott520664_6188:0.000001,ott520664_6169:0.000001):0.000001,ott520664_4573:0.000001):0.000001):0.000001):0.000001):0.000001):0.000001):0.000001,ott520664_5946:0.000001):0.000001,ott520664_5335:0.000001):0.000001,(((ott520664_6518:0.000001,ott520664_4866:0.000001):0.000001,ott520664_6663:0.000001):0.000001,ott520664_6691:0.000001):0.000001):0.000001):0.000001):0.000001,(ott520664_1962:0.000001,ott520664_6932:0.000001):0.000001):0.000001,ott520664_1968:0.000001):0.000001,ott520664_7288:0.000001):0.051930,((((((ott213624_3241:0.000001,ott213624_3189:0.000001):0.000001,(ott213624_5006:0.000001,ott213624_4404:0.000001):0.000001):0.000001,ott213624_4204:0.000001):0.000001,((((ott213624_5238:0.000001,ott213624_6250:0.000001):0.000001,(ott213624_5822:0.000001,ott213624_4874:0.000001):0.000001):0.000001,ott213624_3372:0.000001):0.000001,((((((ott213624_5544:0.000001,(ott213624_2838:0.000001,ott213624_6234:0.000001):0.000001):0.000001,(ott213624_6409:0.000001,((ott213624_4235:0.000001,(ott213624_6540:0.000001,(ott213624_6882:0.000001,ott213624_3770:0.000001):0.000001):0.000001):0.000001,((ott213624_2787:0.000001,(ott213624_2379:0.000001,ott213624_2316:0.000001):0.000001):0.000001,ott213624_7131:0.000001):0.000001):0.000001):0.000001):0.000001,ott213624_2822:0.000001):0.000001,(ott213624_5883:0.000001,ott213624_5301:0.000001):0.000001)n3270:0.000001,(((ott213624_4650:0.000001,ott213624_6244:0.000001):0.000001,ott213624_4420:0.000001):0.000001,ott213624_2704:0.000001):0.000001):0.000001,(((ott213624_6902:0.000001,(ott213624_2692:0.000001,ott213624_7154:0.000001):0.000001):0.000001,ott213624_2706:0.000001):0.000001,ott213624_1958:0.000001):0.000001):0.000001):0.000001):0.000001,(ott213624_7052:0.003117,ott213624_5109:0.000001):0.000001):0.000001,ott729276_100081:0.002667):0.000001):4.447660,((ott729276_100080:0.000001,ott729276_100082:0.000001):0.005250,(ott729276_100086:0.001264,(((ott729276_166285:0.000001,((ott729276_100089:0.000001,ott729276_100088:0.000001):0.000001,ott729276_100083:0.000001):0.000001)n3273:0.000001,ott729276_100087:0.000001):0.000001,ott729276_100085:0.000001):0.000001):0.001351):0.004287):0.000001,((((((((ott213624_3240:0.000001,((ott213624_5545:0.000001,ott213624_6541:0.000001):0.000001,ott213624_2691:0.000001):0.000001):0.000001,ott213623_17174:4.301139):0.000001,(ott213624_4855:0.000001,ott213624_4857:0.000001):0.000001):0.000001,ott213624_3196:0.000001):0.000001,ott213624_4254:0.000001):0.000001,(ott213623_101218:0.006796,ott213623_101219:0.000001):0.000001):0.000001,((ott213624_3188:0.000001,ott213624_3373:0.000001):0.000001,((ott213624_4541:0.000001,ott213624_2705:0.000001):0.000001,(ott213624_5882:0.000001,ott213624_4098:0.000001):0.000001):0.000001):0.000001):0.000001,(((ott213624_5511:0.001841,((ott520664_5204:0.562865,ott6098865_15725:0.661686):0.661698,ott6098865_15210:0.016242):4.526815)n3247:0.000001,(ott6098865_15211:0.000001,ott6098865_15726:0.000001)n3253:0.001146):0.000001,(ott213624_7155:0.000001,((ott506860_150648:0.001204,ott6098862_16364:0.002833):0.000001,(ott213624_2413:0.000001,(((((((((((ott213624_6245:0.000001,(ott213624_4421:0.000001,ott213624_4205:0.000001):0.000001):0.000001,(ott213624_2378:0.000001,(((ott213624_16712:0.008734,(ott213624_3771:0.000915,ott213624_2786:0.000001):0.000001):0.000001,(ott213624_4649:0.000001,ott213624_5108:0.000001):0.000001):0.000920,ott213624_6881:0.000001):0.000917):0.000001):0.000001,ott213624_4236:0.000001)n3242:0.000001,ott213624_3392:0.000001):0.000001,ott213624_6903:0.000001):0.000001,(ott213624_7051:0.000001,ott213624_2317:0.000001):0.000001):0.000001,(ott213624_6434:0.000001,(ott213624_5005:0.000001,ott213624_1957:0.000001):0.000001):0.000001):0.000001,((ott213624_4925:0.000001,ott213624_6361:0.000001):0.000001,ott213624_2821:0.000001):0.000001):0.000001,ott213624_4405:0.000001):0.000001,(ott213624_5300:0.000001,ott213624_7130:0.000001):0.000001):0.000001,ott213624_4873:0.000001):0.000001):0.000001):0.000001):0.000001):0.000001):0.001895):0.001949):0.000001,ott502528_101020:0.007182):0.000633,((ott123041_95558:0.009876,ott5233427_177577:4.574719):0.000001,((ott1047369_95238:4.461976,(ott1047369_95239:0.001476,ott1047369_95237:0.000001)n3260:0.000116):0.001431,((((ott1087338_93644:0.000001,ott1087338_93646:0.000001):0.007369,ott520664_4732:0.062264):0.002522,ott1087338_93645:5.051307):0.000001,(ott1019694_100875:4.712512,ott1019694_100864:0.000001):0.003695):0.000747):0.003051):0.000001):0.001516):0.010897):0.000001):0.000905,((ott520664_16275:0.000001,ott520664_16274:0.000001):0.001112,(((((ott520664_3354:0.000001,(ott520664_6561:0.000001,ott520664_5923:0.000001):0.000001)n3268:0.000001,(ott520664_3913:0.000001,ott520664_5837:0.000001):0.000001):0.000001,ott520664_7215:0.000001):0.000001,((ott520664_5287:0.000001,ott520664_7171:0.000001):0.000001,((((ott520664_2592:0.000001,ott520664_5193:0.000001):0.000001,ott520664_7348:0.000001):0.000001,ott520664_4734:0.000001):0.000001,ott520664_6831:0.000001):0.000001):0.000001):0.001824,(ott520664_5564:0.000001,(ott520664_1970:0.000001,(ott520664_5351:0.000001,ott520664_2041:0.000001):0.000001):0.000001):0.000001):0.001829):0.000001):0.000001):0.000001,((((ott520664_4145:0.000001,(ott520664_7166:0.000001,ott520664_2680:0.000001):0.000001):0.000001,ott520664_5546:0.000001):0.000001,(ott520664_3043:0.000001,ott520664_5219:0.000001):0.000001):0.000001,ott520664_3581:0.000001):0.000001):0.000001):0.000001,(((((ott520664_5345:0.000001,(((ott520664_5455:0.000001,ott520664_3304:0.000001):0.000001,ott520664_6083:0.000001):0.000001,ott520664_5829:0.000001):0.000001):0.000001,(((ott520664_4151:0.000001,(ott520664_6759:0.000001,ott520664_1982:0.000001)n3249:0.000001):0.000001,ott520664_5153:0.000001):0.000001,ott520664_3837:0.000001):0.000001):0.000001,(ott520664_3577:0.000001,(ott520664_2270:0.000001,((((ott520664_7061:0.000001,(ott520664_3468:0.000001,ott520664_6615:0.000001):0.000001):0.000001,ott520664_2572:0.000001):0.000001,(ott520664_6424:0.000001,ott520664_6330:0.000001):0.000001):0.000001,((ott520664_2196:0.000001,ott520664_3119:0.000001):0.000001,ott520664_2044:0.000001):0.000001):0.000001):0.000001):0.000001)n3243:0.000001,(ott520664_1981:0.000001,ott520664_2678:0.000001):0.000001):0.000001,(((ott520664_3369:0.000001,(ott520664_7451:0.000001,ott520664_2377:0.000001):0.000001):0.000001,(ott520664_3282:0.000001,(ott520664_5280:0.000001,ott520664_1983:0.000001):0.000001):0.000001):0.000001,(ott520664_6861:0.000001,(ott520664_6190:0.000001,ott520664_3549:0.000001):0.000001):0.000001):0.000001):0.000001):0.000001,(ott520664_6895:0.000001,ott520664_5398:0.000001):0.000001):0.000001,ott520664_6771:0.000001,ott520664_4082:0.000001);"
    with open(subtree, "r") as sub:
        subtree = sub.read()
    tree2 = Tree(subtree, format=1)
    leave2 = str(leave)[3:]
    found = tree2.search_nodes(name=leave2)
    return found, tree2

def loop_over_fam(path):
    tree = ""
    for family in path:
        logger.info("Looping over family folders")
        if family != "backbone":
            subtree_file = "../data/fasta/{}/{}.fasta.raxml.bestTree".format(family,family)
            backbone = read_backbone(backbone_file="../data/fasta/backbone/rep.bestTree")
            tree = alter_backbone(backbone, subtree_file)
            logger.info("Added subtree to backbone")
    logger.info("Writing tree to file")
    tree.write(format=1, outfile="../data/fasta/backbone/filled_backbone.tree")




if __name__ == "__main__":
    logger = logging.getLogger(__name__)
    logging.basicConfig(level=logging.INFO)
    path2 = os.getcwd()  # Get current working directory
    path = snakemake.input[0]  # noqa: F821
    #outputfile = snakemake.output[0]    # noqa: F821
    total_path = os.path.join(path2, path)
    family_list = os.listdir(os.path.join(path2, path))
    loop_over_fam(family_list)